@model FinalProject.Models.UserAndRecipesViewModel
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery



@{
    ViewData["Title"] = "Home";
}

@if (TempData["SuccessMessage"] != null)
{
    <div id="successAlert" class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["LoginSuccess"] != null)
{
    <div id="loginAlert" class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["LoginSuccess"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}
@if (ViewBag.LoginFailed != null && ViewBag.LoginFailed == true)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        Invalid email or password
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}


<div class="text-center mb-4">
    <h1 class="mb-2">Discover Delicious Recipes</h1>
    <p class="text-muted">Search by ingredients, browse categories, and find your next favorite dish</p>
</div>

<div class="search-card bg-white">
    <!-- Search Input -->
    <div class="mb-4">
        <form method="get" asp-action="Index" asp-controller="Home" class="input-group">
            <span class="input-group-text bg-white border-end-0">
                <i class="bi bi-search"></i>
            </span>
            <input type="text"
                   name="recipeName"
                   value="@ViewBag.SearchRecipeName"
                   class="form-control border-start-0 rounded"
                   placeholder="Search recipes by name..." />
            <button type="submit" class="btn btn-primary">Search</button>
        </form>
    </div>

    <!-- Category buttons -->
    <div class="mb-4">
        <label class="form-label mb-2">Category</label>
        <div class="d-flex flex-wrap gap-3">
            <button class="category-btn @(ViewBag.SelectedCategoryId == 0 ? "active" : "")"
                    onclick="location.href='@Url.Action("Index", "Home", new { categoryId = 0 })'">
                All Categories
            </button>

            @foreach (var category in Model.Categories)
            {
                <button class="category-btn @(ViewBag.SelectedCategoryId == category.Id ? "active" : "")"
                        onclick="location.href='@Url.Action("Index", "Home", new { categoryId = category.Id })'">
                    @category.Name
                </button>
            }
        </div>
    </div>

    <!-- Ingredient search -->
    <form method="get" asp-action="Index" asp-controller="Home" class="input-group mb-3">
        <input type="text"
               name="ingredient"
               value="@ViewBag.SearchIngredient"
               class="form-control"
               placeholder="Enter ingredients separated by commas, e.g., chicken, garlic, onion" />
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
</div>


@if (ViewBag.IsFiltered != true && ViewBag.FeaturedRecipes != null && ((List<FinalProject.Models.Recipe>)ViewBag.FeaturedRecipes).Any())
{
    var featuredRecipes = (List<FinalProject.Models.Recipe>)ViewBag.FeaturedRecipes;
    <div class="mb-5">
        <div class="d-flex align-items-center gap-2 mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-warning">
                <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"></path>
            </svg>
            <h2 class="h5 mb-0">Featured Recipes</h2>
        </div>

        <div class="row g-4 mb-5">
            @foreach (var recipe in featuredRecipes)
            {
                <div class="col-12 col-md-6 col-lg-4">
                    <div class="card recipe-card h-100 overflow-hidden position-relative border-warning border-2">
                        <a asp-action="Recipe_Details" asp-route-id="@recipe.Id" class="d-block">
                            <img src="@recipe.ImageUrl" class="card-img-top recipe-img" />
                        </a>

                        <div class="position-absolute top-0 start-0 w-100 d-flex justify-content-between p-2">
                            <div class="d-flex gap-1">
                                <span class="badge rounded-pill bg-warning text-white"
                                      style="height: 1.8rem; line-height: 1.8rem; padding: 0 0.75rem; font-size: 0.85rem; display: inline-block;">
                                    @recipe.Category.Name
                                </span>
                                <span class="badge rounded-pill bg-danger text-white"
                                      style="height: 1.8rem; line-height: 1.8rem; padding: 0 0.75rem; font-size: 0.75rem; display: inline-block;">
                                    ⭐ Featured
                                </span>
                            </div>

                            <button type="button" class="btn p-2 rounded-circle"
                                    style="background-color: rgba(255,255,255,0.9);"
                                    onclick="toggleFavorite(@recipe.Id, this)">

                                @{
                                    var isFavorite = Model.User?.FavoriteRecipes?.Any(f => f.RecipeId == recipe.Id) == true;
                                    var heartClass = isFavorite ? "text-danger" : "text-secondary";
                                }

                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                     stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                     class="w-5 h-5 @heartClass">
                                    <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"></path>
                                </svg>
                            </button>
                        </div>

                        <a asp-action="Recipe_Details" asp-route-id="@recipe.Id" class="text-decoration-none text-dark">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title text-truncate">@recipe.Name</h5>
                                <p class="card-text text-truncate-2">@recipe.Description</p>
                                <div class="d-flex justify-content-between text-muted small">
                                    <div><i class="bi bi-clock"></i>@recipe.PrepTime min</div>
                                    <div><i class="bi bi-people"></i>@recipe.Servings servings</div>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            }
        </div>
    </div>
}

<!-- All Recipes -->
<div class="mb-5">
    <div class="d-flex align-items-center gap-2 mb-4">
        <i class="bi bi-trending-up text-warning"></i>
        <h2 class="h5 mb-0">
            @if (!string.IsNullOrEmpty(ViewBag.SearchRecipeName))
            {
                @:Search results for "@ViewBag.SearchRecipeName"
            }
            else if (!string.IsNullOrEmpty(ViewBag.SearchIngredient))
            {
                @:Recipes with ingredients: @ViewBag.SearchIngredient
            }
            else if (ViewBag.SelectedCategoryId != 0)
            {
                var category = Model.Categories.FirstOrDefault(c => c.Id == ViewBag.SelectedCategoryId);
                @:Recipes in category: @(category?.Name ?? "Unknown")
            }
            else
            {
                @:All Recipes
            }
        </h2>
    </div>

    @if (!Model.Recipes.Any())
    {
        <div class="alert alert-info mt-3">
            No recipes found in this category. Try changing the category, ingredients, or recipe name.
        </div>
    }

    <div class="row g-4">
        @foreach (var recipe in Model.Recipes)
        {
            <div class="col-12 col-md-6 col-lg-4">
                <div class="card recipe-card h-100 overflow-hidden position-relative">

                    
                    <a asp-action="Recipe_Details" asp-route-id="@recipe.Id" class="d-block">
                        <img src="@recipe.ImageUrl" class="card-img-top recipe-img" />
                    </a>

            
                    <div class="position-absolute top-0 start-0 w-100 d-flex justify-content-between p-2">
                        <div class="d-flex gap-1">
                            <span class="badge rounded-pill bg-warning text-white"
                                  style="height: 1.8rem; line-height: 1.8rem; padding: 0 0.75rem; font-size: 0.85rem; display: inline-block;">
                                @recipe.Category.Name
                            </span>
                            @if (recipe.IsFeatured)
                            {
                                <span class="badge rounded-pill bg-danger text-white"
                                      style="height: 1.8rem; line-height: 1.8rem; padding: 0 0.75rem; font-size: 0.75rem; display: inline-block;">
                                    ⭐ Featured
                                </span>
                            }
                        </div>

                        <button type="button" class="btn p-2 rounded-circle"
                                style="background-color: rgba(255,255,255,0.9);"
                                onclick="toggleFavorite(@recipe.Id, this)">

                            @{
                                var isFavorite = Model.User?.FavoriteRecipes?.Any(f => f.RecipeId == recipe.Id) == true;
                                var heartClass = isFavorite ? "text-danger" : "text-secondary";
                            }

                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                 class="w-5 h-5 @heartClass">
                                <path d="M2 9.5a5.5 5.5 0 0 1 9.591-3.676.56.56 0 0 0 .818 0A5.49 5.49 0 0 1 22 9.5c0 2.29-1.5 4-3 5.5l-5.492 5.313a2 2 0 0 1-3 .019L5 15c-1.5-1.5-3-3.2-3-5.5"></path>
                            </svg>
                        </button>
                    </div>





                   
                    <a asp-action="Recipe_Details" asp-route-id="@recipe.Id" class="text-decoration-none text-dark">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title text-truncate">@recipe.Name</h5>
                            <p class="card-text text-truncate-2">@recipe.Description</p>
                            <div class="d-flex justify-content-between text-muted small">
                                <div><i class="bi bi-clock"></i>@recipe.PrepTime min</div>
                                <div><i class="bi bi-people"></i>@recipe.Servings servings</div>
                            </div>
                        </div>
                    </a>

                </div>
            </div>
        }
    </div>
</div>


<div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>Login</h5>
                <button type="button" class="btn btn-light p-1 rounded-circle" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <form method="post" asp-controller="Account" asp-action="Login">
                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" name="email" id="email" class="form-control" required />
                    <span asp-validation-for="User.Email" class="text-danger"></span>

                </div>
                <div class="mb-3">
                    <label>Password</label>
                    <input type="password" name="password" id="password" class="form-control" required />
                    <span asp-validation-for="User.Password" class="text-danger"></span>
                </div>
                @if (TempData["LoginErrorMessage"] != null)
                {
                    <div class="alert alert-danger" role="alert">
                        @TempData["LoginErrorMessage"]
                    </div>
                }
                <button type="submit" class="btn btn-login w-100 mt-3">Login</button>
            </form>
            <button class="btn btn-outline-warning mt-3" data-bs-toggle="modal" data-bs-target="#signupModal" data-bs-dismiss="modal">Sign Up</button>
            <div class="mt-4 p-3 bg-info bg-opacity-10 rounded">
                <p class="small mb-0">
                    <strong>Guest Mode:</strong> Browse and search without logging in. Login to like, rate, comment, and upload recipes!
                </p>
            </div>
        </div>
    </div>
</div>


<div class="modal fade" id="signupModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5>Sign Up</h5>
                <button type="button" class="btn btn-light p-1 rounded-circle" data-bs-dismiss="modal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            @if (TempData["RegisterError"] != null)
            {
                <div class="alert alert-danger">
                    @TempData["RegisterError"]
                </div>
            }
            <form method="post" asp-controller="Account" asp-action="Register">
                <div class="mb-3">
                    <label>Name</label>
                    <input asp-for="User.Name" class="form-control" />
                    <span asp-validation-for="User.Name" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label>Email</label>
                    <input asp-for="User.Email" class="form-control" />
                    <span asp-validation-for="User.Email" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label>Password</label>
                    <input asp-for="User.Password" type="password" class="form-control" />
                    <span asp-validation-for="User.Password" class="text-danger"></span>
                </div>

                <div class="mb-3">
                    <label>Confirm Password</label>
                    <input asp-for="User.ConfirmPassword" type="password" class="form-control" />
                    <span asp-validation-for="User.ConfirmPassword" class="text-danger"></span>
                </div>

                <button type="submit" class="btn btn-signup w-100 mt-3">Sign Up</button>
            </form>

            <div class="text-center mt-2">
                <button class="btn btn-link text-warning p-0" data-bs-toggle="modal" data-bs-target="#loginModal" data-bs-dismiss="modal">
                    Already have an account? Login
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var openRegisterModal = @((TempData["OpenRegisterModal"] != null).ToString().ToLower());

        if (openRegisterModal) {
            new bootstrap.Modal(document.getElementById('signupModal')).show();
        }

        var openLoginModal = @((TempData["OpenLoginModal"] != null && (bool)TempData["OpenLoginModal"]).ToString().ToLower());
        if (openRegisterModal) {
            var signupModal = new bootstrap.Modal(document.getElementById('signupModal'));
            signupModal.show();
        }
        if (openLoginModal) {
            var loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
            loginModal.show();
        }

        var loginErrorMessage = '@TempData["LoginErrorMessage"]';
        if (loginErrorMessage) {
            var alert = document.createElement('div');
            alert.className = "alert alert-danger alert-dismissible fade show";
            alert.role = "alert";
            alert.innerHTML = loginErrorMessage +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>';
            document.body.appendChild(alert);
        }

        var alert = document.getElementById('successAlert');
        if (alert) {
            setTimeout(function() {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }, 3000);
        }

        var loginAlert = document.getElementById('loginAlert');
        if (loginAlert) {
            setTimeout(function() {
                var bsAlert = new bootstrap.Alert(loginAlert);
                bsAlert.close();
            }, 3000); 
        }
    });
    function toggleFavorite(recipeId, btn) {
        fetch('/Home/ToggleFavorite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': '@Antiforgery.GetAndStoreTokens(Context).RequestToken'
            },
            body: JSON.stringify({ recipeId: recipeId })
        })
        .then(response => {
            if (response.ok) {
                const svg = btn.querySelector('svg');
                svg.classList.toggle('text-danger');
            } else if (response.status === 401) {
                alert('You need to log in to favorite recipes.');
            } else {
                alert('Something went wrong.');
            }
        });
    }

</script>


@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}





