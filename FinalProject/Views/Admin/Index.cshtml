@{
    ViewData["Title"] = "Admin Dashboard";
    var activeTab = ViewBag.ActiveTab ?? "Dashboard";
}

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="container my-5">
    <div class="mb-4">
        <h1 class="mb-2">Admin Dashboard</h1>
        <p class="text-muted">Manage your recipe platform</p>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "Dashboard" ? "active" : "")" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">
                Dashboard
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "Recipes" ? "active" : "")" id="recipes-tab" data-bs-toggle="tab" data-bs-target="#recipes" type="button" role="tab">
                Recipes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "Users" ? "active" : "")" id="users-tab" data-bs-toggle="tab" data-bs-target="#users" type="button" role="tab">
                Users
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(activeTab == "Comments" ? "active" : "")" id="comments-tab" data-bs-toggle="tab" data-bs-target="#comments" type="button" role="tab">
                Comments
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Dashboard Tab -->
        <div class="tab-pane fade @(activeTab == "Dashboard" ? "show active" : "")" id="dashboard" role="tabpanel">
            <div id="dashboard-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recipes Tab -->
        <div class="tab-pane fade @(activeTab == "Recipes" ? "show active" : "")" id="recipes" role="tabpanel">
            <div id="recipes-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-pane fade @(activeTab == "Users" ? "show active" : "")" id="users" role="tabpanel">
            <div id="users-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Comments Tab -->
        <div class="tab-pane fade @(activeTab == "Comments" ? "show active" : "")" id="comments" role="tabpanel">
            <div id="comments-content">
                <div class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Load dashboard data
    function loadDashboard() {
        fetch('/Admin/GetDashboardData')
            .then(res => res.json())
            .then(data => {
                const html = `
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Recipes</h6>
                                    <h3 class="mb-0">${data.totalRecipes}</h3>
                                    <small class="text-muted">${data.pendingRecipes} pending approval</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Users</h6>
                                    <h3 class="mb-0">${data.totalUsers}</h3>
                                    <small class="text-muted">${data.activeUsers} active users</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Total Comments</h6>
                                    <h3 class="mb-0">${data.totalComments}</h3>
                                    <small class="text-muted">Across all recipes</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Average Rating</h6>
                                    <h3 class="mb-0">${data.averageRating}</h3>
                                    <small class="text-muted">Overall platform rating</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Growth Trends</h5>
                                    <div class="chart-wrapper">
                                        <canvas id="growthChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Recipe Categories</h5>
                                    <div class="chart-wrapper">
                                        <canvas id="categoryChart" height="200"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">Top Rated Recipes</h5>
                                    <div class="list-group">
                                        ${data.topRecipes.map(r => `
                                            <a href="/Home/Recipe_Details/${r.id}" class="list-group-item list-group-item-action" style="cursor: pointer;">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <h6 class="mb-1">${r.name}</h6>
                                                        <small class="text-muted">${r.category}</small>
                                                    </div>
                                                    <div class="text-end">
                                                        <span class="badge bg-warning">${r.rating.toFixed(1)} ‚≠ê</span>
                                                        <small class="text-muted d-block">${r.likes} likes</small>
                                                    </div>
                                                </div>
                                            </a>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('dashboard-content').innerHTML = html;
                
                // Draw charts using Chart.js
                setTimeout(() => {
                    drawGrowthChart(data.growthData);
                    drawCategoryChart(data.categoryData);
                }, 100);
            });
    }

    let growthChartInstance = null;
    let categoryChartInstance = null;

    function drawGrowthChart(data) {
        const canvas = document.getElementById('growthChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Destroy existing chart if it exists
        if (growthChartInstance) {
            growthChartInstance.destroy();
        }
        
        const labels = data.map(d => d.month);
        const recipesData = data.map(d => d.recipes);
        const usersData = data.map(d => d.users);
        
        growthChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Recipes',
                    data: recipesData,
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.2)',
                    tension: 0.1
                }, {
                    label: 'Users',
                    data: usersData,
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    function drawCategoryChart(data) {
        const canvas = document.getElementById('categoryChart');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        
        // Destroy existing chart if it exists
        if (categoryChartInstance) {
            categoryChartInstance.destroy();
        }
        
        const labels = data.map(d => d.category);
        const counts = data.map(d => d.count);
        
        categoryChartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: counts,
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.8)',
                        'rgba(54, 162, 235, 0.8)',
                        'rgba(255, 206, 86, 0.8)',
                        'rgba(75, 192, 192, 0.8)',
                        'rgba(153, 102, 255, 0.8)',
                        'rgba(255, 159, 64, 0.8)'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom'
                    }
                }
            }
        });
    }

    // Load recipes
    function loadRecipes() {
        fetch('/Admin/GetRecipes')
            .then(res => res.json())
            .then(data => {
                const html = `
                    ${data.pendingRecipes.length > 0 ? `
                        <div class="mb-4 d-flex align-items-center p-3 rounded" style="background-color: #ff9800; color: white;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="me-2" style="flex-shrink: 0;">
                                <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                                <path d="M12 9v4"></path>
                                <path d="M12 17h.01"></path>
                            </svg>
                            <div>
                                <strong>Pending Approval</strong> - These recipes need your review
                            </div>
                        </div>
                        <div class="table-responsive mb-4">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Title</th>
                                        <th>Author</th>
                                        <th>Category</th>
                                        <th>Created</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.pendingRecipes.map(r => `
                                        <tr>
                                            <td><a href="/Home/Recipe_Details/${r.id}" target="_blank" class="text-decoration-none">${r.title}</a></td>
                                            <td>${r.author}</td>
                                            <td>${r.category}</td>
                                            <td>${r.created}</td>
                                            <td>
                                                <button class="btn btn-sm btn-success me-1" onclick="approveRecipe(${r.id})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                                                        <path d="M20 6 9 17l-5-5"></path>
                                                    </svg>
                                                    Approve
                                                </button>
                                                <button class="btn btn-sm btn-danger" onclick="rejectRecipe(${r.id})">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align: middle;">
                                                        <path d="M18 6 6 18"></path>
                                                        <path d="m6 6 12 12"></path>
                                                    </svg>
                                                    Reject
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    ` : ''}
                    <h5 class="mb-3">All Recipes</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Category</th>
                                    <th>Status</th>
                                    <th>Rating</th>
                                    <th>Likes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.allRecipes.map(r => `
                                    <tr>
                                        <td><a href="/Home/Recipe_Details/${r.id}" target="_blank">${r.title}</a></td>
                                        <td>${r.category}</td>
                                        <td><span class="badge ${r.status === 'Approved' ? 'bg-success' : 'bg-warning'}">${r.status}</span></td>
                                        <td>${r.rating ? r.rating.toFixed(1) : '0.0'}</td>
                                        <td>${r.likes}</td>
                                        <td>
                                            <button class="btn btn-sm ${r.isFeatured ? 'btn-secondary' : 'btn-primary'}" onclick="toggleFeature(${r.id}, ${r.isFeatured})">${r.isFeatured ? 'Unfeature' : 'Feature'}</button>
                                            <button class="btn btn-sm btn-danger" onclick="deleteRecipe(${r.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('recipes-content').innerHTML = html;
            });
    }

    // Load users
    function loadUsers() {
        fetch('/Admin/GetUsers')
            .then(res => res.json())
            .then(data => {
                const html = `
                    <h5 class="mb-3">User Management</h5>
                    <div class="table-responsive mb-4">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Recipes</th>
                                    <th>Comments</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.users.map(u => `
                                    <tr>
                                        <td>${u.name}</td>
                                        <td>${u.email}</td>
                                        <td><span class="badge ${u.status === 'Active' ? 'bg-success' : 'bg-danger'}">${u.status}</span></td>
                                        <td>${u.joined}</td>
                                        <td>${u.recipesCount}</td>
                                        <td>${u.commentsCount}</td>
                                        <td>
                                            ${u.status === 'Active' 
                                                ? `<button class="btn btn-sm btn-warning" onclick="suspendUser(${u.id})">Suspend</button>`
                                                : `<button class="btn btn-sm btn-success" onclick="activateUser(${u.id})">Activate</button>`
                                            }
                                            <button class="btn btn-sm btn-danger" onclick="deleteUser(${u.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3>${data.activeUsers}</h3>
                                    <p class="text-muted mb-0">Active Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3>${data.suspendedUsers}</h3>
                                    <p class="text-muted mb-0">Suspended Users</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h3>${data.totalUsers}</h3>
                                    <p class="text-muted mb-0">Total Users</p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('users-content').innerHTML = html;
            });
    }

    // Load comments
    function loadComments() {
        fetch('/Admin/GetComments')
            .then(res => res.json())
            .then(data => {
                const html = `
                    <h5 class="mb-3">Comment Moderation</h5>
                    <p class="text-muted mb-4">Review and manage all comments</p>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Author</th>
                                    <th>Comment</th>
                                    <th>Recipe</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.map(c => `
                                    <tr>
                                        <td>${c.author}</td>
                                        <td>${c.content}</td>
                                        <td>
                                            <a href="/Home/Recipe_Details/${c.recipeId}"
                                               target="_blank"
                                               class="text-decoration-none">
                                                ${c.recipe}
                                            </a>
                                        </td>
                                        <td>${c.date}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" onclick="deleteComment(${c.id})">Delete</button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                document.getElementById('comments-content').innerHTML = html;
            });
    }

    // Action functions
    function approveRecipe(id) {
        fetch(`/Admin/ApproveRecipe?id=${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                loadRecipes();
            });
    }

    function rejectRecipe(id) {
        if (confirm('Are you sure you want to reject this recipe?')) {
            fetch(`/Admin/RejectRecipe?id=${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadRecipes();
                });
        }
    }

    function deleteRecipe(id) {
        if (confirm('Are you sure you want to delete this recipe?')) {
            fetch(`/Admin/DeleteRecipe?id=${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadRecipes();
                });
        }
    }

    function toggleFeature(id, currentStatus) {
        fetch(`/Admin/ToggleFeature?id=${id}`, { method: 'POST' })
            .then(res => {
                if (!res.ok) {
                    throw new Error('Failed to toggle feature status');
                }
                return res.json();
            })
            .then(data => {
                alert(data.isFeatured ? 'Recipe featured successfully!' : 'Recipe unfeatured successfully!');
                loadRecipes();
            })
            .catch(error => {
                alert('Error toggling feature status: ' + error.message);
            });
    }

    function suspendUser(id) {
        if (confirm('Are you sure you want to suspend this user?')) {
            fetch(`/Admin/SuspendUser?id=${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadUsers();
                });
        }
    }

    function activateUser(id) {
        fetch(`/Admin/ActivateUser?id=${id}`, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                alert(data.message);
                loadUsers();
            });
    }

    function deleteUser(id) {
        if (confirm('Are you sure you want to delete this user?')) {
            fetch(`/Admin/DeleteUser?id=${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadUsers();
                });
        }
    }

    function deleteComment(id) {
        if (confirm('Are you sure you want to delete this comment?')) {
            fetch(`/Admin/DeleteComment?id=${id}`, { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    loadComments();
                });
        }
    }

    // Load data when tab is shown
    document.addEventListener('DOMContentLoaded', function() {
        const activeTab = '@activeTab';
        if (activeTab === 'Dashboard') loadDashboard();
        else if (activeTab === 'Recipes') loadRecipes();
        else if (activeTab === 'Users') loadUsers();
        else if (activeTab === 'Comments') loadComments();

        // Load data when switching tabs
        document.getElementById('dashboard-tab').addEventListener('shown.bs.tab', loadDashboard);
        document.getElementById('recipes-tab').addEventListener('shown.bs.tab', loadRecipes);
        document.getElementById('users-tab').addEventListener('shown.bs.tab', loadUsers);
        document.getElementById('comments-tab').addEventListener('shown.bs.tab', loadComments);
    });
</script>


